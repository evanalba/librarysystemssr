use librarysystemssr;

INSERT INTO books (
    title, 
    authors, 
    publication_year, 
    isbn, 
    description, 
    page_count, 
    available_copies, 
    total_copies, 
    image_url
) VALUES (
    'The Practice of Programming',
    'Brian W. Kernighan, Rob Pike',
    1999,
    '9780201615869',
    '"Brian Kernighan and Rob Pike have written The Practice of Programming to help make individual programmers more effective and productive." "The practice of programming is more than just writing code. Programmers must also assess tradeoffs, choose among design alternatives, debug and test, improve performance, and maintain software written by themselves and others. At the same time, they must be concerned with issues like compatibility, robustness, and reliability, while meeting specifications." "The Practice of Programming covers all these topics, and more. This book is full of practical advice and real-world examples in C, C++, Java, and a variety of special-purpose languages."--Jacket', -- Note: Storing a search link in the description field
    279,
    2,
    2,
    'https://coverart.oclc.org/ImageWebSvc/oclc/+-+35104059_140.jpg?allowDefault=false&client=WorldcatOrgUI'
);

SET SQL_SAFE_UPDATES = 1;
DELETE FROM books where publication_year = 1998;

SET FOREIGN_KEY_CHECKS = 1;
TRUNCATE TABLE users;

select * from books;
describe books;

ALTER TABLE books
ADD CONSTRAINT check_copies_consistency CHECK (available_copies <= total_copies);

SHOW CREATE TABLE books;
select * from users;
DESCRIBE users;

select * from books;
select * from loans;
describe loans;
-- Alter Loans Table to include copy_id for easy retriable.

DELETE FROM loans
WHERE user_id = 1;
DROP TABLE loans;

SHOW CREATE TABLE loans;


describe copies;
select * from copies;
SHOW CREATE TABLE copies;

INSERT INTO users (username, password, role) VALUES ("epicdog1", "test", "patron");
INSERT INTO copies (copy_id, book_id, status) VALUES ("C1", 8, "Available");
INSERT INTO copies (copy_id, book_id, status) VALUES ("C2", 8, "Checked Out");
INSERT INTO copies (copy_id, book_id, status) VALUES ("C4", 8, "Available");



CREATE TABLE copies (
    copy_id VARCHAR(20) NOT NULL PRIMARY KEY,
    book_id INT NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT "Available",
    CONSTRAINT chk_status CHECK (Status IN ("Available", "Checked Out")),
    FOREIGN KEY (book_id)
    REFERENCES books(id)
    ON DELETE RESTRICT
	ON UPDATE CASCADE
);

-- 1. Drop the constraint that checks if available_copies is less than total_copies
ALTER TABLE books
DROP CONSTRAINT check_copies_consistency;

-- 2. Drop the constraint that checks if available_copies is non-negative
ALTER TABLE books
DROP CONSTRAINT check_available_copies_non_negative;

ALTER TABLE books
DROP COLUMN available_copies,
DROP COLUMN total_copies;



